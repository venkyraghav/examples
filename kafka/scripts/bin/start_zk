#!/bin/bash

ExportVars() {
    export DATA_DIR
    # export kafka.logs.dir="${LOG_DIR}/zk"
    export KAFKA_LOG4J_OPTS="-Dkafka.logs.dir=${LOG_DIR}/zk -Dlog4j.configuration=file://${PROP_DIR}/log4j_zk.properties"
    export JMX_PORT=8080
    export JOLOKIA_PORT=7770
    export NODE_ID="0"

    export KAFKA_OPTS=$( GetNodePattern )

    KAFKA_JMX_OPTS="-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.host=${MY_IP} -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false"
    KAFKA_JMX_OPTS="${KAFKA_JMX_OPTS} -Djava.rmi.server.hostname=${MY_IP}"
    KAFKA_JMX_OPTS="${KAFKA_JMX_OPTS} -Djava.net.preferIPv4Stack=true"
    KAFKA_JMX_OPTS="${KAFKA_JMX_OPTS} -javaagent:${JAR_DIR}/jolokia-jvm-1.6.2-agent.jar=config=${CFG_DIR}/zk_jolokia.properties"
    KAFKA_JMX_OPTS="${KAFKA_JMX_OPTS} -javaagent:${JAR_DIR}/jmx_prometheus_javaagent-0.16.1.jar=${JMX_PORT}:${PROP_DIR}/zookeeper.yml"
    export KAFKA_JMX_OPTS
}

ProcessArgs() {
    POSITIONAL_ARGS=()
    export NOHUP=0
    export PROG_NAME=$0
    export NODE_TYPE="ZK"
    if [[ $# -eq 0 ]]; then
        return
    fi

    while [[ $# -gt 0 ]]; do
    case $1 in
        -n|--nohup)
        export NOHUP=1
        shift # past argument
        ;;
        -h|--help)
        MyEcho "INFO" "Printing help"
        Usage
        exit 0
        ;;
        -*|--*)
        MyEcho "ERROR" "Unknown option $1"
        Usage
        exit 1
        ;;
        *)
        POSITIONAL_ARGS+=("$1") # save positional arg
        shift # past argument
        ;;
    esac
    done

    set -- "${POSITIONAL_ARGS[@]}" # restore positional parameters
}

Validate() {
    CheckProcessNotRunningOrExit "${NODE_TYPE}"
}

EchoVars() {
    MyEcho "INFO" "KAFKA_LOG4J_OPTS=${KAFKA_LOG4J_OPTS}"
    MyEcho "INFO" "KAFKA_OPTS=${KAFKA_OPTS}"
    MyEcho "INFO" "KAFKA_JMX_OPTS=${KAFKA_JMX_OPTS}"
    MyEcho "INFO" "MY_IP=${MY_IP}"
    MyEcho "INFO" "JOLOKIA_PORT=${JOLOKIA_PORT}"
    MyEcho "INFO" "JMX_PORT=${JMX_PORT}"
    MyEcho "INFO" "DATA_DIR=${DATA_DIR}"
}

GenerateProperties() {
    # RunJ2 ${J2_DIR}/zookeeper.properties.j2 ${CFG_DIR}/zookeeper.properties
    # RunJ2 ${J2_DIR}/jolokia.properties.j2 ${CFG_DIR}/zk_jolokia.properties
    RunEnvsubst ${TEMPLATE_DIR}/zookeeper.properties.template ${CFG_DIR}/zookeeper.properties
    RunEnvsubst ${TEMPLATE_DIR}/jolokia.properties.template ${CFG_DIR}/zk_jolokia.properties
}

main() {
    source ${base_dir}/common
    Precheck
    ProcessArgs $@
    ExportVars
    Validate
    EchoVars
    GenerateProperties

    MyEcho "INFO" "Starting Zookeeper ..."
    MyEcho "INFO" "${CONFLUENT_HOME}/bin/zookeeper-server-start ${CFG_DIR}/zookeeper.properties ..."
    if [[ ${NOHUP} -eq 1 ]] ; then
        nohup ${CONFLUENT_HOME}/bin/zookeeper-server-start ${CFG_DIR}/zookeeper.properties 2>&1 > ${LOG_DIR}/zk_${NODE_ID}.log &
    else
        ${CONFLUENT_HOME}/bin/zookeeper-server-start ${CFG_DIR}/zookeeper.properties
    fi

    echo "ZK=${MY_IP}:2181" > ${STATE_FILE}
}

######################################################################
# Main Processing Starts Here
######################################################################
base_dir=$(dirname $0)
main $@
