#!/bin/bash

# Usage
Usage() {
    echo "Usage: ${PROG_NAME}"
    echo "  -f|--fresh: create fresh cluster (default: ${DEFAULT_FRESH})"
    echo "  -C|--cluster-id: cluster-id to use or ${DEFAULT_CLUSTER_ID} for fresh cluster (default: ${DEFAULT_CLUSTER_ID})"
    echo "  -D|--dry-run: perform dry run (default: ${DEFAULT_DRY_RUN})"
    echo "  -b|--broker-id: broker id (default: ${DEFAULT_NODE_ID})"
    echo "  -d|--dc-id: data center id (default: ${DEFAULT_DC_ID})"
    echo "  -k|--kraft-mode. Values none, controller, kraftbroker (default: ${DEFAULT_KRAFT_MODE})"
    echo "  -c|--controller-quorum (default: ${DEFAULT_CONTROLLER_QUORUM})"
    echo "  -r|--replication-factor: replication factor (default: ${DEFAULT_REPLICATION_FACTOR})"
    echo "  -m|--min-isr: min isr (default: ${DEFAULT_MIN_ISR})"
    echo "  -n|--nohup: run in background (default: ${DEFAULT_NOHUP})"
    echo "  -a|--authn: authn method. Values noauth, plain, scram, gssapi, rbac (default: ${DEFAULT_AUTHN})"
    echo "  -h|--help: print help"
}

# Validate
Validate() {
    ValidateKraftMode "${KRAFT_MODE}"

    ValidateNodeIDOrExit "${NODE_ID}"
    CheckNodeNotRunningOrExit "${NODE_TYPE}" "${NODE_ID}"

    ValidateReplicationFactorOrExit "${REPLICATION_FACTOR}" "${MIN_ISR}"
    ValidateAuthNMethodOrExit "${AUTHN}"
}

# Export vars
ExportVars() {
    export ZK_PORT=2181

    case ${KRAFT_MODE} in
        none|kraftbroker)
        LISTENERS_PORT=9091
        CONFLUENT_HTTP_SERVER_LISTENERS=8091
        JMX_PORT=18081
        JOLOKIA_PORT=17771
        ;;
        controller)
        LISTENERS_PORT=9051
        CONFLUENT_HTTP_SERVER_LISTENERS=8051
        JMX_PORT=18051
        JOLOKIA_PORT=17751
        ;;
        *)
        MyEcho "ERROR" "Unknown value ${KRAFT_MODE} for option -k or --kraft-mode"
        Usage
        exit 1
        ;;
    esac

    export CONFLUENT_HTTP_SERVER_LISTENERS=$(( CONFLUENT_HTTP_SERVER_LISTENERS + NODE_ID ))
    export JMX_PORT=$(( JMX_PORT + NODE_ID ))
    export JOLOKIA_PORT=$(( JOLOKIA_PORT + NODE_ID ))

    ########################################################################################################
    # NODE_ID | LISTENERS_PORT | EXTERNAL_PORT | REPLICATION_PORT | TOKEN_PORT | JOLOKIA_PORT | JMX_PORT
    ########################################################################################################
    # 1         | 9091/9051           | 9191          | 9291             | 9391       | 17771        | 18081
    # 2         | 9092/9052           | 9192          | 9292             | 9392       | 17772        | 18082
    # 3         | 9093/9053           | 9193          | 9293             | 9393       | 17773        | 18083

    export LISTENERS_PORT=$(( LISTENERS_PORT + NODE_ID ))
    if [[ "${AUTHN}" == "rbac" ]] ; then
        export EXTERNAL_PORT=$(( LISTENERS_PORT + 100 ))
        export REPLICATION_PORT=$(( LISTENERS_PORT + 200 ))
        export TOKEN_PORT=$(( LISTENERS_PORT + 300 ))
    fi

    export KAFKA_OPTS=$( GetNodePattern )

    KAFKA_JMX_OPTS="-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.host=${MY_IP} -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false"
    KAFKA_JMX_OPTS="${KAFKA_JMX_OPTS} -Djava.rmi.server.hostname=${MY_IP}"
    KAFKA_JMX_OPTS="${KAFKA_JMX_OPTS} -Djava.net.preferIPv4Stack=true"
    KAFKA_JMX_OPTS="${KAFKA_JMX_OPTS} -javaagent:${JAR_DIR}/jolokia-jvm-1.6.2-agent.jar=config=${CFG_DIR}/kafka_jolokia_${NODE_ID}.properties"
    KAFKA_JMX_OPTS="${KAFKA_JMX_OPTS} -javaagent:${JAR_DIR}/jmx_prometheus_javaagent-0.16.1.jar=${JMX_PORT}:${PROP_DIR}/kafka_broker.yml"
    export KAFKA_JMX_OPTS

    KAFKA_LOG4J_OPTS="-Dlog4j.configuration=file://${CFG_DIR}/log4j_${NODE_ID}.properties"
    export KAFKA_LOG4J_OPTS
}

# Echo vars
EchoVars() {
    echo ""
    MyEcho "INFO" "####################"
    MyEcho "INFO" "Begin All Vars"
    MyEcho "INFO" "####################"
    MyEcho "INFO" "PROG_NAME=${PROG_NAME}"
    MyEcho "INFO" "DC_ID=${DC_ID}"
    MyEcho "INFO" "NODE_TYPE=${NODE_TYPE}"
    MyEcho "INFO" "NODE_ID=${NODE_ID}"
    MyEcho "INFO" "FRESH=${FRESH}"
    MyEcho "INFO" "CLUSTER_ID=${CLUSTER_ID}"
    MyEcho "INFO" "DRY_RUN=${DRY_RUN}"
    MyEcho "INFO" "KRAFT_MODE=${KRAFT_MODE}"
    MyEcho "INFO" "CONTROLLER_QUORUM=${CONTROLLER_QUORUM}"
    MyEcho "INFO" "CONTROLLER_QUORUM_BOOTSTRAP=${CONTROLLER_QUORUM_BOOTSTRAP}"
    MyEcho "INFO" "REPLICATION_FACTOR=${REPLICATION_FACTOR}"
    MyEcho "INFO" "MIN_ISR=${MIN_ISR}"

    MyEcho "INFO" "ZK_PORT=${ZK_PORT}"
    MyEcho "INFO" "CONFLUENT_HTTP_SERVER_LISTENERS=${CONFLUENT_HTTP_SERVER_LISTENERS}"
    MyEcho "INFO" "JOLOKIA_PORT=${JOLOKIA_PORT}"
    MyEcho "INFO" "JMX_PORT=${JMX_PORT}"
    MyEcho "INFO" "LISTENERS_PORT=${LISTENERS_PORT}"
    if [[ "${AUTHN}" == "rbac" ]] ; then
        MyEcho "INFO" "EXTERNAL_PORT=${EXTERNAL_PORT}"
        MyEcho "INFO" "REPLICATION_PORT=${REPLICATION_PORT}"
        MyEcho "INFO" "TOKEN_PORT=${TOKEN_PORT}"
    fi

    MyEcho "INFO" "KAFKA_OPTS=${KAFKA_OPTS}"
    MyEcho "INFO" "KAFKA_JMX_OPTS=${KAFKA_JMX_OPTS}"
    MyEcho "INFO" "KAFKA_LOG4J_OPTS=${KAFKA_LOG4J_OPTS}"

    MyEcho "INFO" "LOG_DIR=${LOG_DIR}"
    MyEcho "INFO" "DATA_DIR=${DATA_DIR}"
    MyEcho "INFO" "CFG_DIR=${CFG_DIR}"
    MyEcho "INFO" "JAR_DIR=${JAR_DIR}"
    MyEcho "INFO" "PROP_DIR=${PROP_DIR}"
    MyEcho "INFO" "AUTHN=${AUTHN}"
    MyEcho "INFO" "NOHUP=${NOHUP}"
    MyEcho "INFO" "####################"
    MyEcho "INFO" "End All Vars"
    MyEcho "INFO" "####################"
    echo ""
    echo ""
}

InitNode() {
    if [[ "${FRESH}" -eq "0" ]] ; then
        return
    fi
    if [[ ${DRY_RUN} -eq "1" ]] ; then
        MyEcho "INFO" "InitNode DryRun for ${KRAFT_MODE}"
        return
    fi
    case ${KRAFT_MODE} in
        controller)
        ${CONFLUENT_HOME}/bin/kafka-storage format -t ${CLUSTER_ID}  -c ${PROP_FILE} --no-initial-controllers
        ;;
        kraftbroker)
        ${CONFLUENT_HOME}/bin/kafka-storage format -t ${CLUSTER_ID} -c ${PROP_FILE}
        ;;
        *)
        MyEcho "ERROR" "Unknown value ${KRAFT_MODE} for option -k or --kraft-mode"
        Usage
        exit 1
        ;;
    esac
}

# Generate properties
GenerateProperties() {
    case ${KRAFT_MODE} in
        none)
        PROP_TMPL=server-${AUTHN}.properties.template
        PROP_FILE=${CFG_DIR}/server_${NODE_ID}.properties
        ;;
        kraftbroker)
        PROP_TMPL=broker-kraft-${AUTHN}.properties.template
        PROP_FILE=${CFG_DIR}/broker-kraft_${NODE_ID}.properties
        ;;
        controller)
        PROP_TMPL=controller-${AUTHN}.properties.template
        PROP_FILE=${CFG_DIR}/controller_${NODE_ID}.properties
        ;;
        *)
        MyEcho "ERROR" "Unknown value ${KRAFT_MODE} for option -k or --kraft-mode"
        Usage
        exit 1
        ;;
    esac
    export PROP_FILE

    if [[ "${FRESH}" -eq "1" ]] ; then
        RunEnvsubst ${TEMPLATE_DIR}/${PROP_TMPL} ${PROP_FILE}
        RunEnvsubst ${TEMPLATE_DIR}/jolokia.properties.template ${CFG_DIR}/kafka_jolokia_${NODE_ID}.properties
        RunEnvsubst ${TEMPLATE_DIR}/log4j.properties.template ${CFG_DIR}/log4j_${NODE_ID}.properties
        InitNode
    fi
}

# Process args
ProcessArgs() {
    POSITIONAL_ARGS=()

    export NODE_TYPE="AK"

    export DEFAULT_CLUSTER_ID=0
    export CLUSTER_ID=${DEFAULT_CLUSTER_ID}

    export DEFAULT_DRY_RUN=0
    export DRY_RUN=${DEFAULT_DRY_RUN}

    export DEFAULT_FRESH=0
    export FRESH=${DEFAULT_FRESH}

    export DEFAULT_DC_ID=1
    export DC_ID=${DEFAULT_DC_ID}

    export DEFAULT_NODE_ID=0
    export NODE_ID=${DEFAULT_NODE_ID}

    export DEFAULT_REPLICATION_FACTOR=1
    export REPLICATION_FACTOR=${DEFAULT_REPLICATION_FACTOR}

    export DEFAULT_MIN_ISR=1
    export MIN_ISR=${DEFAULT_MIN_ISR}

    export DEFAULT_NOHUP=0
    export NOHUP=${DEFAULT_NOHUP}

    export DEFAULT_AUTHN=noauth
    export AUTHN=${DEFAULT_AUTHN}

    export DEFAULT_KRAFT_MODE=kraftbroker
    export KRAFT_MODE=${DEFAULT_KRAFT_MODE}

    export DEFAULT_CONTROLLER_QUORUM="0@${MY_IP}:9051"
    export CONTROLLER_QUORUM=${DEFAULT_CONTROLLER_QUORUM}

    export PROG_NAME=$0
    if [[ $# -eq 0 ]]; then
        return
    fi

    while [[ $# -gt 0 ]]; do
    case $1 in
        -a|--authn)
        export AUTHN=`echo $2 | tr '[:upper:]' '[:lower:]'`
        shift # past argument
        shift # past value
        ;;
        -k|--kraft-mode)
        export KRAFT_MODE=`echo $2 | tr '[:upper:]' '[:lower:]'`
        shift # past argument
        shift # past value
        ;;
        -c|--controller-quorum)
        export CONTROLLER_QUORUM="${2}"
        shift # past argument
        shift # past value
        ;;
        -b|--broker-id)
        export NODE_ID="${2}"
        shift # past argument
        shift # past value
        ;;
        -d|--dc-id)
        export DC_ID="$2"
        shift # past argument
        shift # past value
        ;;
        -r|--replication-factor)
        export REPLICATION_FACTOR="$2"
        shift # past argument
        shift # past value
        ;;
        -m|--min-isr)
        export MIN_ISR="$2"
        shift # past argument
        shift # past value
        ;;
        -n|--nohup)
        export NOHUP=1
        shift # past argument
        ;;
        -C|--cluster-id)
        export CLUSTER_ID="$2"
        shift # past argument
        shift # past value
        ;;
        -f|--fresh)
        export FRESH=1
        shift # past argument
        ;;
        -D|--dry-run)
        export DRY_RUN=1
        shift # past argument
        ;;
        -h|--help)
        MyEcho "INFO" "Printing help"
        Usage
        exit 0
        ;;
        -*|--*)
        MyEcho "ERROR" "Unknown option $1"
        Usage
        exit 1
        ;;
        *)
        POSITIONAL_ARGS+=("$1") # save positional arg
        shift # past argument
        ;;
    esac
    done

    set -- "${POSITIONAL_ARGS[@]}" # restore positional parameters
}

# Main function
main() {
    source ${base_dir}/common
    Precheck
    ProcessArgs $@
    ExportVars
    Validate
    EchoVars
    GenerateProperties

    MyEcho "INFO" "Starting ${NODE_TYPE} DC ${DC_ID} node ${NODE_ID} ..."
    MyEcho "INFO" "${CONFLUENT_HOME}/bin/kafka-server-start ${PROP_FILE}"
    if [[ ${DRY_RUN} -eq 0 ]] ; then
        if [[ ${NOHUP} -eq 1 ]] ; then
            nohup ${CONFLUENT_HOME}/bin/kafka-server-start ${PROP_FILE} 2>&1 > ${LOG_DIR}/${NODE_TYPE}_${DC_ID}_${NODE_ID}_nohup.log &
        else
            ${CONFLUENT_HOME}/bin/kafka-server-start ${PROP_FILE}
        fi

        echo "${NODE_TYPE}_${DC_ID}_${NODE_ID}=${MY_IP}:${LISTENERS_PORT}" >> ${STATE_FILE}
    fi
}

######################################################################
# Main Processing Starts Here
######################################################################
base_dir=$(dirname $0)
main $@
