#!/bin/bash

# Usage
Usage() {
    echo "Usage: ${PROG_NAME} "
    echo "  -b|--broker-id: broker id (default: 0)"
    echo "  -d|--dc-id: data center id (default: 1)"
    echo "  -r|--replication-factor: replication factor (default: 1)"
    echo "  -m|--min-isr: min isr (default: 1)"
    echo "  -n|--nohup: run in background (default: false)"
    echo "  -a|--authn: authn method. Values noauth, plain, scram, gssapi, rbac (default: noauth)"
    echo "  -h|--help: print help"
}

# Validate
Validate() {
    ValidateNodeIDOrExit "${NODE_ID}"
    CheckNodeNotRunningOrExit "${NODE_TYPE}" "${NODE_ID}"

    ValidateReplicationFactorOrExit "${REPLICATION_FACTOR}" "${MIN_ISR}"
    ValidateAuthNMethodOrExit "${AUTHN}"
}

# Export vars
ExportVars() {
    export ZK_PORT=2181
    CONFLUENT_HTTP_SERVER_LISTENERS=8090
    export CONFLUENT_HTTP_SERVER_LISTENERS=$(( CONFLUENT_HTTP_SERVER_LISTENERS + NODE_ID ))

    JMX_PORT=18080
    export JMX_PORT=$(( JMX_PORT + NODE_ID ))

    JOLOKIA_PORT=17770
    export JOLOKIA_PORT=$(( JOLOKIA_PORT + NODE_ID ))

    ########################################################################################################
    # NODE_ID | LISTENERS_PORT | EXTERNAL_PORT | REPLICATION_PORT | TOKEN_PORT | JOLOKIA_PORT | JMX_PORT
    ########################################################################################################
    # 1         | 9091           | 9191          | 9291             | 9391       | 17771        | 18081
    # 2         | 9092           | 9192          | 9292             | 9392       | 17772        | 18082
    # 3         | 9093           | 9193          | 9293             | 9393       | 17773        | 18083

    LISTENERS_PORT=9090
    export LISTENERS_PORT=$(( LISTENERS_PORT + NODE_ID ))
    if [[ ${AUTHN} -eq "rbac" ]] ; then
        export EXTERNAL_PORT=$(( LISTENERS_PORT + 100 ))
        export REPLICATION_PORT=$(( LISTENERS_PORT + 200 ))
        export TOKEN_PORT=$(( LISTENERS_PORT + 300 ))
    fi

    export KAFKA_OPTS=$( GetNodePattern )

    KAFKA_JMX_OPTS="-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.host=${MY_IP} -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false"
    KAFKA_JMX_OPTS="${KAFKA_JMX_OPTS} -Djava.rmi.server.hostname=${MY_IP}"
    KAFKA_JMX_OPTS="${KAFKA_JMX_OPTS} -Djava.net.preferIPv4Stack=true"
    KAFKA_JMX_OPTS="${KAFKA_JMX_OPTS} -javaagent:${JAR_DIR}/jolokia-jvm-1.6.2-agent.jar=config=${CFG_DIR}/kafka_jolokia_${NODE_ID}.properties"
    KAFKA_JMX_OPTS="${KAFKA_JMX_OPTS} -javaagent:${JAR_DIR}/jmx_prometheus_javaagent-0.16.1.jar=${JMX_PORT}:${PROP_DIR}/kafka_broker.yml"
    export KAFKA_JMX_OPTS

    KAFKA_LOG4J_OPTS="-Dlog4j.configuration=file://${CFG_DIR}/log4j_${NODE_ID}.properties"
    export KAFKA_LOG4J_OPTS
}

# Echo vars
EchoVars() {
    echo ""
    MyEcho "INFO" "####################"
    MyEcho "INFO" "Begin All Vars"
    MyEcho "INFO" "####################"
    MyEcho "INFO" "PROG_NAME=${PROG_NAME}"
    MyEcho "INFO" "DC_ID=${DC_ID}"
    MyEcho "INFO" "NODE_TYPE=${NODE_TYPE}"
    MyEcho "INFO" "NODE_ID=${NODE_ID}"
    MyEcho "INFO" "REPLICATION_FACTOR=${REPLICATION_FACTOR}"
    MyEcho "INFO" "MIN_ISR=${MIN_ISR}"

    MyEcho "INFO" "ZK_PORT=${ZK_PORT}"
    MyEcho "INFO" "CONFLUENT_HTTP_SERVER_LISTENERS=${CONFLUENT_HTTP_SERVER_LISTENERS}"
    MyEcho "INFO" "JOLOKIA_PORT=${JOLOKIA_PORT}"
    MyEcho "INFO" "JMX_PORT=${JMX_PORT}"
    MyEcho "INFO" "LISTENERS_PORT=${LISTENERS_PORT}"
    if [[ ${AUTHN} -eq "rbac" ]] ; then
        MyEcho "INFO" "EXTERNAL_PORT=${EXTERNAL_PORT}"
        MyEcho "INFO" "REPLICATION_PORT=${REPLICATION_PORT}"
        MyEcho "INFO" "TOKEN_PORT=${TOKEN_PORT}"
    fi

    MyEcho "INFO" "KAFKA_OPTS=${KAFKA_OPTS}"
    # MyEcho "INFO" "KAFKA_JMX_OPTS=${KAFKA_JMX_OPTS}"
    MyEcho "INFO" "KAFKA_LOG4J_OPTS=${KAFKA_LOG4J_OPTS}"

    MyEcho "INFO" "LOG_DIR=${LOG_DIR}"
    MyEcho "INFO" "DATA_DIR=${DATA_DIR}"
    MyEcho "INFO" "CFG_DIR=${CFG_DIR}"
    MyEcho "INFO" "JAR_DIR=${JAR_DIR}"
    MyEcho "INFO" "PROP_DIR=${PROP_DIR}"
    MyEcho "INFO" "AUTHN=${AUTHN}"
    MyEcho "INFO" "NOHUP=${NOHUP}"
    MyEcho "INFO" "####################"
    MyEcho "INFO" "End All Vars"
    MyEcho "INFO" "####################"
    echo ""
    echo ""
}

# Generate properties
GenerateProperties() {
    # RunJ2 ${J2_DIR}/server-${AUTHN}.properties.j2 ${CFG_DIR}/server_${NODE_ID}.properties
    # RunJ2 ${J2_DIR}/jolokia.properties.j2 ${CFG_DIR}/kafka_jolokia_${NODE_ID}.properties
    # RunJ2 ${J2_DIR}/log4j.properties.j2 ${CFG_DIR}/log4j_${NODE_ID}.properties
    RunEnvsubst ${TEMPLATE_DIR}/server-${AUTHN}.properties.template ${CFG_DIR}/server_${NODE_ID}.properties
    RunEnvsubst ${TEMPLATE_DIR}/jolokia.properties.template ${CFG_DIR}/kafka_jolokia_${NODE_ID}.properties
    RunEnvsubst ${TEMPLATE_DIR}/log4j.properties.template ${CFG_DIR}/log4j_${NODE_ID}.properties
}

# Process args
ProcessArgs() {
    POSITIONAL_ARGS=()

    export DC_ID=1
    export NODE_TYPE="AK"
    export NODE_ID=0
    export REPLICATION_FACTOR=1
    export MIN_ISR=1
    export NOHUP=0
    export AUTHN=noauth

    export PROG_NAME=$0
    if [[ $# -eq 0 ]]; then
        return
    fi

    while [[ $# -gt 0 ]]; do
    case $1 in
        -a|--authn)
        export AUTHN=`echo $2 | tr '[:upper:]' '[:lower:]'`
        shift # past argument
        shift # past value
        ;;
        -b|--broker-id)
        export NODE_ID="${2}"
        shift # past argument
        shift # past value
        ;;
        -d|--dc-id)
        export DC_ID="$2"
        shift # past argument
        shift # past value
        ;;
        -r|--replication-factor)
        export REPLICATION_FACTOR="$2"
        shift # past argument
        shift # past value
        ;;
        -m|--min-isr)
        export MIN_ISR="$2"
        shift # past argument
        shift # past value
        ;;
        -n|--nohup)
        export NOHUP=1
        shift # past argument
        ;;
        -h|--help)
        MyEcho "INFO" "Printing help"
        Usage
        exit 0
        ;;
        -*|--*)
        MyEcho "ERROR" "Unknown option $1"
        Usage
        exit 1
        ;;
        *)
        POSITIONAL_ARGS+=("$1") # save positional arg
        shift # past argument
        ;;
    esac
    done

    set -- "${POSITIONAL_ARGS[@]}" # restore positional parameters
}

# Main function
main() {
    source ${base_dir}/common
    Precheck
    ProcessArgs $@
    ExportVars
    Validate
    EchoVars
    GenerateProperties

    MyEcho "INFO" "Starting broker ${NODE_ID} ..."
    MyEcho "INFO" "${CONFLUENT_HOME}/bin/kafka-server-start ${CFG_DIR}/server_${NODE_ID}.properties"
    if [[ ${NOHUP} -eq 1 ]] ; then
        nohup ${CONFLUENT_HOME}/bin/kafka-server-start ${CFG_DIR}/server_${NODE_ID}.properties 2>&1 > ${LOG_DIR}/ak_${NODE_ID}.log &
    else
        ${CONFLUENT_HOME}/bin/kafka-server-start ${CFG_DIR}/server_${NODE_ID}.properties
    fi

    echo "AK_${DC_ID}_${NODE_ID}=${MY_IP}:${LISTENERS_PORT}" >> ${STATE_FILE}
}

######################################################################
# Main Processing Starts Here
######################################################################
base_dir=$(dirname $0)
main $@
