#!/bin/bash

# Usage
Usage() {
    echo "Usage: ${PROG_NAME} "
    echo "  -b|--bootstrap-server: bootstrap server (default: ${DEFAULT_BOOTSTRAP_SERVERS})"
    echo "  -i|--sr-id: id of the cluster (default: 0)"
    echo "  -n|--nohup: run in background (default: false)"
    echo "  -a|--authn: authn method. Values noauth, plain, scram, gssapi, rbac (default: noauth)"
    echo "  -h|--help: print help"
}

# Validate
Validate() {
    ValidateNodeIDOrExit "${NODE_ID}"
    CheckNodeNotRunningOrExit "${NODE_TYPE}" "${NODE_ID}"

    ValidateAuthNMethodOrExit "${AUTHN}"
}

# Export vars
ExportVars() {
    export JMX_PORT=28180
    export JOLOKIA_PORT=27870
    export LISTENERS_PORT=8081

    export SCHEMA_REGISTRY_OPTS=$( GetNodePattern )

    SCHEMA_REGISTRY_JMX_OPTS="-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.host=${MY_IP} -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false"
    SCHEMA_REGISTRY_JMX_OPTS="${SCHEMA_REGISTRY_JMX_OPTS} -Djava.rmi.server.hostname=${MY_IP}"
    SCHEMA_REGISTRY_JMX_OPTS="${SCHEMA_REGISTRY_JMX_OPTS} -Djava.net.preferIPv4Stack=true"
    SCHEMA_REGISTRY_JMX_OPTS="${SCHEMA_REGISTRY_JMX_OPTS} -javaagent:${JAR_DIR}/jolokia-jvm-1.6.2-agent.jar=config=${CFG_DIR}/schema-registry_jolokia_${NODE_ID}.properties"
    SCHEMA_REGISTRY_JMX_OPTS="${SCHEMA_REGISTRY_JMX_OPTS} -javaagent:${JAR_DIR}/jmx_prometheus_javaagent-0.16.1.jar=${JMX_PORT}:${PROP_DIR}/kafka_broker.yml"
    export SCHEMA_REGISTRY_JMX_OPTS

    SCHEMA_REGISTRY_LOG4J_OPTS="-Dkafka.logs.dir=${LOG_DIR} -Dlog4j.configuration=file://${CFG_DIR}/log4j_sr_${NODE_ID}.properties"
    export SCHEMA_REGISTRY_LOG4J_OPTS
}

# Echo vars
EchoVars() {
    echo ""
    echo ""
    MyEcho "INFO" "####################"
    MyEcho "INFO" "Begin All Vars"
    MyEcho "INFO" "####################"
    MyEcho "INFO" "PROG_NAME=${PROG_NAME}"
    MyEcho "INFO" "NODE_TYPE=${NODE_TYPE}"
    MyEcho "INFO" "NODE_ID=${NODE_ID}"
    MyEcho "INFO" "BOOTSTRAP_SERVERS=${BOOTSTRAP_SERVERS}"

    MyEcho "INFO" "JOLOKIA_PORT=${JOLOKIA_PORT}"
    MyEcho "INFO" "JMX_PORT=${JMX_PORT}"
    MyEcho "INFO" "LISTENERS_PORT=${LISTENERS_PORT}"

    MyEcho "INFO" "SCHEMA_REGISTRY_OPTS=${SCHEMA_REGISTRY_OPTS}"
    MyEcho "INFO" "SCHEMA_REGISTRY_JMX_OPTS=${SCHEMA_REGISTRY_JMX_OPTS}"
    MyEcho "INFO" "SCHEMA_REGISTRY_LOG4J_OPTS=${SCHEMA_REGISTRY_LOG4J_OPTS}"

    MyEcho "INFO" "LOG_DIR=${LOG_DIR}"
    MyEcho "INFO" "DATA_DIR=${DATA_DIR}"
    MyEcho "INFO" "TEMPLATE_DIR=${TEMPLATE_DIR}"
    MyEcho "INFO" "CP_DIR=${CP_DIR}"
    MyEcho "INFO" "CFG_DIR=${CFG_DIR}"
    MyEcho "INFO" "JAR_DIR=${JAR_DIR}"
    MyEcho "INFO" "RBAC_ENABLED=${RBAC_ENABLED}"
    MyEcho "INFO" "NOHUP=${NOHUP}"
    MyEcho "INFO" "####################"
    MyEcho "INFO" "End All Vars"
    MyEcho "INFO" "####################"
    echo ""
    echo ""
}

# Generate properties
GenerateProperties() {
    RunEnvsubst ${TEMPLATE_DIR}/schema-registry-${AUTHN}.properties.template ${CFG_DIR}/schema-registry_${NODE_ID}.properties
    RunEnvsubst ${TEMPLATE_DIR}/jolokia.properties.template ${CFG_DIR}/schema-registry_jolokia_${NODE_ID}.properties
    RunEnvsubst ${TEMPLATE_DIR}/log4j.properties.template ${CFG_DIR}/log4j_sr_${NODE_ID}.properties
}

# Process args
ProcessArgs() {
    POSITIONAL_ARGS=()

    export NODE_TYPE="SR"
    export NODE_ID=0
    export DEFAULT_BOOTSTRAP_SERVERS="${MY_IP}:9092"
    export BOOTSTRAP_SERVERS="${DEFAULT_BOOTSTRAP_SERVERS}"

    export RBAC_ENABLED=0
    export NOHUP=0
    export AUTHN=noauth

    export PROG_NAME=$0
    if [[ $# -eq 0 ]]; then
        return
    fi

    while [[ $# -gt 0 ]]; do
    case $1 in
        -a|--authn)
        export AUTHN=`echo $2 | tr '[:upper:]' '[:lower:]'`
        shift # past argument
        shift # past value
        ;;
        -b|--bootstrap-server)
        export BOOTSTRAP_SERVERS="$2"
        shift # past argument
        shift # past value
        ;;
        -i|sr-id)
        export NODE_ID="$2"
        shift # past argument
        shift # past value
        ;;
        -n|--nohup)
        export NOHUP=1
        shift # past argument
        ;;
        -h|--help)
        MyEcho "INFO" "Printing help"
        Usage
        exit 0
        ;;
        -*|--*)
        MyEcho "ERROR" "Unknown option $1"
        Usage
        exit 1
        ;;
        *)
        POSITIONAL_ARGS+=("$1") # save positional arg
        shift # past argument
        ;;
    esac
    done

    set -- "${POSITIONAL_ARGS[@]}" # restore positional parameters
}

# Main function
main() {
    source ${base_dir}/common
    Precheck
    ProcessArgs $@
    ExportVars
    Validate
    EchoVars
    GenerateProperties

    MyEcho "INFO" "Starting schema registry ${NODE_ID} ..."
    MyEcho "INFO" "${CONFLUENT_HOME}/bin/schema-registry-start ${CFG_DIR}/schema-registry_${NODE_ID}.properties"
    if [[ ${NOHUP} -eq 1 ]] ; then
        nohup ${CONFLUENT_HOME}/bin/schema-registry-start ${CFG_DIR}/schema-registry_${NODE_ID}.properties 2>&1 > ${LOG_DIR}/schema-registry_${NODE_ID}.log &
    else
        ${CONFLUENT_HOME}/bin/schema-registry-start ${CFG_DIR}/schema-registry_${NODE_ID}.properties
    fi

    echo "${NODE_TYPE}_${NODE_ID}=http://${MY_IP}:${LISTENERS_PORT}" >> ${STATE_FILE}
}

######################################################################
# Main Processing Starts Here
######################################################################
base_dir=$(dirname $0)
main $@
